"use strict";var cov_cey5canse=function(){var path="C:\\Users\\PRAKASHSELVARAJ\\Blockchain\\Home Depot\\Development\\chaincode_0901\\src\\contracts\\invoice.contract.ts";var hash="1b03a79e0c4de170586fc7cc01470571c69a6857";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"C:\\Users\\PRAKASHSELVARAJ\\Blockchain\\Home Depot\\Development\\chaincode_0901\\src\\contracts\\invoice.contract.ts",statementMap:{"0":{start:{line:2,column:17},end:{line:7,column:1}},"1":{start:{line:3,column:12},end:{line:3,column:28}},"2":{start:{line:3,column:34},end:{line:3,column:125}},"3":{start:{line:4,column:4},end:{line:5,column:150}},"4":{start:{line:4,column:79},end:{line:4,column:131}},"5":{start:{line:5,column:9},end:{line:5,column:150}},"6":{start:{line:5,column:22},end:{line:5,column:43}},"7":{start:{line:5,column:58},end:{line:5,column:150}},"8":{start:{line:5,column:81},end:{line:5,column:150}},"9":{start:{line:6,column:4},end:{line:6,column:66}},"10":{start:{line:8,column:17},end:{line:10,column:1}},"11":{start:{line:9,column:4},end:{line:9,column:109}},"12":{start:{line:9,column:79},end:{line:9,column:109}},"13":{start:{line:11,column:0},end:{line:11,column:62}},"14":{start:{line:12,column:30},end:{line:12,column:60}},"15":{start:{line:13,column:17},end:{line:13,column:37}},"16":{start:{line:14,column:23},end:{line:14,column:49}},"17":{start:{line:15,column:28},end:{line:15,column:59}},"18":{start:{line:16,column:15},end:{line:16,column:35}},"19":{start:{line:17,column:15},end:{line:17,column:70}},"20":{start:{line:18,column:22},end:{line:134,column:1}},"21":{start:{line:19,column:20},end:{line:19,column:71}},"22":{start:{line:22,column:8},end:{line:39,column:9}},"23":{start:{line:24,column:12},end:{line:26,column:13}},"24":{start:{line:25,column:16},end:{line:25,column:78}},"25":{start:{line:28,column:22},end:{line:28,column:24}},"26":{start:{line:29,column:12},end:{line:32,column:13}},"27":{start:{line:30,column:37},end:{line:30,column:115}},"28":{start:{line:31,column:16},end:{line:31,column:41}},"29":{start:{line:33,column:12},end:{line:33,column:23}},"30":{start:{line:36,column:12},end:{line:36,column:51}},"31":{start:{line:37,column:12},end:{line:37,column:28}},"32":{start:{line:38,column:12},end:{line:38,column:19}},"33":{start:{line:43,column:8},end:{line:132,column:9}},"34":{start:{line:45,column:12},end:{line:45,column:39}},"35":{start:{line:46,column:12},end:{line:48,column:13}},"36":{start:{line:47,column:16},end:{line:47,column:107}},"37":{start:{line:49,column:12},end:{line:51,column:13}},"38":{start:{line:49,column:51},end:{line:49,column:83}},"39":{start:{line:50,column:16},end:{line:50,column:121}},"40":{start:{line:52,column:25},end:{line:52,column:75}},"41":{start:{line:54,column:21},end:{line:54,column:74}},"42":{start:{line:55,column:26},end:{line:55,column:30}},"43":{start:{line:56,column:12},end:{line:61,column:13}},"44":{start:{line:57,column:16},end:{line:57,column:60}},"45":{start:{line:58,column:16},end:{line:58,column:48}},"46":{start:{line:59,column:16},end:{line:59,column:32}},"47":{start:{line:60,column:16},end:{line:60,column:58}},"48":{start:{line:63,column:12},end:{line:63,column:61}},"49":{start:{line:64,column:26},end:{line:64,column:91}},"50":{start:{line:65,column:12},end:{line:67,column:13}},"51":{start:{line:66,column:16},end:{line:66,column:72}},"52":{start:{line:68,column:12},end:{line:68,column:47}},"53":{start:{line:70,column:12},end:{line:70,column:62}},"54":{start:{line:71,column:30},end:{line:71,column:89}},"55":{start:{line:72,column:12},end:{line:74,column:13}},"56":{start:{line:73,column:16},end:{line:73,column:70}},"57":{start:{line:75,column:12},end:{line:75,column:51}},"58":{start:{line:77,column:12},end:{line:77,column:140}},"59":{start:{line:78,column:12},end:{line:111,column:13}},"60":{start:{line:80,column:16},end:{line:80,column:84}},"61":{start:{line:81,column:16},end:{line:89,column:19}},"62":{start:{line:82,column:46},end:{line:84,column:22}},"63":{start:{line:83,column:24},end:{line:83,column:158}},"64":{start:{line:85,column:20},end:{line:88,column:21}},"65":{start:{line:86,column:24},end:{line:86,column:85}},"66":{start:{line:87,column:24},end:{line:87,column:62}},"67":{start:{line:91,column:33},end:{line:100,column:22}},"68":{start:{line:92,column:46},end:{line:94,column:22}},"69":{start:{line:93,column:24},end:{line:93,column:158}},"70":{start:{line:95,column:20},end:{line:98,column:21}},"71":{start:{line:96,column:24},end:{line:96,column:94}},"72":{start:{line:97,column:24},end:{line:97,column:37}},"73":{start:{line:99,column:20},end:{line:99,column:31}},"74":{start:{line:101,column:16},end:{line:101,column:88}},"75":{start:{line:103,column:16},end:{line:106,column:17}},"76":{start:{line:104,column:20},end:{line:104,column:102}},"77":{start:{line:105,column:20},end:{line:105,column:52}},"78":{start:{line:109,column:16},end:{line:109,column:86}},"79":{start:{line:110,column:16},end:{line:110,column:80}},"80":{start:{line:113,column:12},end:{line:113,column:59}},"81":{start:{line:114,column:28},end:{line:114,column:110}},"82":{start:{line:115,column:12},end:{line:115,column:59}},"83":{start:{line:117,column:12},end:{line:124,column:13}},"84":{start:{line:118,column:16},end:{line:118,column:62}},"85":{start:{line:119,column:16},end:{line:119,column:47}},"86":{start:{line:122,column:16},end:{line:122,column:68}},"87":{start:{line:123,column:16},end:{line:123,column:47}},"88":{start:{line:125,column:12},end:{line:125,column:110}},"89":{start:{line:126,column:12},end:{line:126,column:29}},"90":{start:{line:129,column:12},end:{line:129,column:72}},"91":{start:{line:130,column:12},end:{line:130,column:28}},"92":{start:{line:131,column:12},end:{line:131,column:19}},"93":{start:{line:135,column:0},end:{line:142,column:55}},"94":{start:{line:143,column:0},end:{line:151,column:51}},"95":{start:{line:152,column:0},end:{line:155,column:20}},"96":{start:{line:156,column:0},end:{line:156,column:42}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:2,column:46},end:{line:2,column:47}},loc:{start:{line:2,column:87},end:{line:7,column:1}},line:2},"1":{name:"(anonymous_1)",decl:{start:{line:8,column:46},end:{line:8,column:47}},loc:{start:{line:8,column:62},end:{line:10,column:1}},line:8},"2":{name:"(anonymous_2)",decl:{start:{line:19,column:4},end:{line:19,column:5}},loc:{start:{line:19,column:18},end:{line:19,column:73}},line:19},"3":{name:"(anonymous_3)",decl:{start:{line:21,column:4},end:{line:21,column:5}},loc:{start:{line:21,column:54},end:{line:40,column:5}},line:21},"4":{name:"(anonymous_4)",decl:{start:{line:42,column:4},end:{line:42,column:5}},loc:{start:{line:42,column:53},end:{line:133,column:5}},line:42},"5":{name:"(anonymous_5)",decl:{start:{line:49,column:36},end:{line:49,column:37}},loc:{start:{line:49,column:49},end:{line:49,column:85}},line:49},"6":{name:"(anonymous_6)",decl:{start:{line:81,column:39},end:{line:81,column:40}},loc:{start:{line:81,column:55},end:{line:89,column:17}},line:81},"7":{name:"(anonymous_7)",decl:{start:{line:82,column:68},end:{line:82,column:69}},loc:{start:{line:82,column:99},end:{line:84,column:21}},line:82},"8":{name:"(anonymous_8)",decl:{start:{line:91,column:55},end:{line:91,column:56}},loc:{start:{line:91,column:76},end:{line:100,column:17}},line:91},"9":{name:"(anonymous_9)",decl:{start:{line:92,column:68},end:{line:92,column:69}},loc:{start:{line:92,column:99},end:{line:94,column:21}},line:92}},branchMap:{"0":{loc:{start:{line:2,column:17},end:{line:7,column:1}},type:"binary-expr",locations:[{start:{line:2,column:18},end:{line:2,column:22}},{start:{line:2,column:26},end:{line:2,column:41}},{start:{line:2,column:46},end:{line:7,column:1}}],line:2},"1":{loc:{start:{line:3,column:34},end:{line:3,column:125}},type:"cond-expr",locations:[{start:{line:3,column:42},end:{line:3,column:48}},{start:{line:3,column:51},end:{line:3,column:125}}],line:3},"2":{loc:{start:{line:3,column:51},end:{line:3,column:125}},type:"cond-expr",locations:[{start:{line:3,column:67},end:{line:3,column:118}},{start:{line:3,column:121},end:{line:3,column:125}}],line:3},"3":{loc:{start:{line:4,column:4},end:{line:5,column:150}},type:"if",locations:[{start:{line:4,column:4},end:{line:5,column:150}},{start:{line:4,column:4},end:{line:5,column:150}}],line:4},"4":{loc:{start:{line:4,column:8},end:{line:4,column:77}},type:"binary-expr",locations:[{start:{line:4,column:8},end:{line:4,column:35}},{start:{line:4,column:39},end:{line:4,column:77}}],line:4},"5":{loc:{start:{line:5,column:58},end:{line:5,column:150}},type:"if",locations:[{start:{line:5,column:58},end:{line:5,column:150}},{start:{line:5,column:58},end:{line:5,column:150}}],line:5},"6":{loc:{start:{line:5,column:85},end:{line:5,column:149}},type:"binary-expr",locations:[{start:{line:5,column:86},end:{line:5,column:143}},{start:{line:5,column:148},end:{line:5,column:149}}],line:5},"7":{loc:{start:{line:5,column:86},end:{line:5,column:143}},type:"cond-expr",locations:[{start:{line:5,column:94},end:{line:5,column:98}},{start:{line:5,column:101},end:{line:5,column:143}}],line:5},"8":{loc:{start:{line:5,column:101},end:{line:5,column:143}},type:"cond-expr",locations:[{start:{line:5,column:109},end:{line:5,column:126}},{start:{line:5,column:129},end:{line:5,column:143}}],line:5},"9":{loc:{start:{line:6,column:11},end:{line:6,column:62}},type:"binary-expr",locations:[{start:{line:6,column:11},end:{line:6,column:16}},{start:{line:6,column:20},end:{line:6,column:21}},{start:{line:6,column:25},end:{line:6,column:62}}],line:6},"10":{loc:{start:{line:8,column:17},end:{line:10,column:1}},type:"binary-expr",locations:[{start:{line:8,column:18},end:{line:8,column:22}},{start:{line:8,column:26},end:{line:8,column:41}},{start:{line:8,column:46},end:{line:10,column:1}}],line:8},"11":{loc:{start:{line:9,column:4},end:{line:9,column:109}},type:"if",locations:[{start:{line:9,column:4},end:{line:9,column:109}},{start:{line:9,column:4},end:{line:9,column:109}}],line:9},"12":{loc:{start:{line:9,column:8},end:{line:9,column:77}},type:"binary-expr",locations:[{start:{line:9,column:8},end:{line:9,column:35}},{start:{line:9,column:39},end:{line:9,column:77}}],line:9},"13":{loc:{start:{line:24,column:12},end:{line:26,column:13}},type:"if",locations:[{start:{line:24,column:12},end:{line:26,column:13}},{start:{line:24,column:12},end:{line:26,column:13}}],line:24},"14":{loc:{start:{line:46,column:12},end:{line:48,column:13}},type:"if",locations:[{start:{line:46,column:12},end:{line:48,column:13}},{start:{line:46,column:12},end:{line:48,column:13}}],line:46},"15":{loc:{start:{line:49,column:12},end:{line:51,column:13}},type:"if",locations:[{start:{line:49,column:12},end:{line:51,column:13}},{start:{line:49,column:12},end:{line:51,column:13}}],line:49},"16":{loc:{start:{line:56,column:12},end:{line:61,column:13}},type:"if",locations:[{start:{line:56,column:12},end:{line:61,column:13}},{start:{line:56,column:12},end:{line:61,column:13}}],line:56},"17":{loc:{start:{line:65,column:12},end:{line:67,column:13}},type:"if",locations:[{start:{line:65,column:12},end:{line:67,column:13}},{start:{line:65,column:12},end:{line:67,column:13}}],line:65},"18":{loc:{start:{line:72,column:12},end:{line:74,column:13}},type:"if",locations:[{start:{line:72,column:12},end:{line:74,column:13}},{start:{line:72,column:12},end:{line:74,column:13}}],line:72},"19":{loc:{start:{line:77,column:34},end:{line:77,column:112}},type:"cond-expr",locations:[{start:{line:77,column:90},end:{line:77,column:96}},{start:{line:77,column:99},end:{line:77,column:112}}],line:77},"20":{loc:{start:{line:77,column:35},end:{line:77,column:86}},type:"binary-expr",locations:[{start:{line:77,column:35},end:{line:77,column:60}},{start:{line:77,column:64},end:{line:77,column:86}}],line:77},"21":{loc:{start:{line:78,column:12},end:{line:111,column:13}},type:"if",locations:[{start:{line:78,column:12},end:{line:111,column:13}},{start:{line:78,column:12},end:{line:111,column:13}}],line:78},"22":{loc:{start:{line:78,column:16},end:{line:78,column:67}},type:"binary-expr",locations:[{start:{line:78,column:16},end:{line:78,column:41}},{start:{line:78,column:45},end:{line:78,column:67}}],line:78},"23":{loc:{start:{line:83,column:31},end:{line:83,column:157}},type:"binary-expr",locations:[{start:{line:83,column:31},end:{line:83,column:52}},{start:{line:83,column:56},end:{line:83,column:77}},{start:{line:83,column:81},end:{line:83,column:112}},{start:{line:83,column:116},end:{line:83,column:157}}],line:83},"24":{loc:{start:{line:85,column:20},end:{line:88,column:21}},type:"if",locations:[{start:{line:85,column:20},end:{line:88,column:21}},{start:{line:85,column:20},end:{line:88,column:21}}],line:85},"25":{loc:{start:{line:93,column:31},end:{line:93,column:157}},type:"binary-expr",locations:[{start:{line:93,column:31},end:{line:93,column:52}},{start:{line:93,column:56},end:{line:93,column:77}},{start:{line:93,column:81},end:{line:93,column:112}},{start:{line:93,column:116},end:{line:93,column:157}}],line:93},"26":{loc:{start:{line:95,column:20},end:{line:98,column:21}},type:"if",locations:[{start:{line:95,column:20},end:{line:98,column:21}},{start:{line:95,column:20},end:{line:98,column:21}}],line:95},"27":{loc:{start:{line:103,column:16},end:{line:106,column:17}},type:"if",locations:[{start:{line:103,column:16},end:{line:106,column:17}},{start:{line:103,column:16},end:{line:106,column:17}}],line:103},"28":{loc:{start:{line:117,column:12},end:{line:124,column:13}},type:"if",locations:[{start:{line:117,column:12},end:{line:124,column:13}},{start:{line:117,column:12},end:{line:124,column:13}}],line:117}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0,"61":0,"62":0,"63":0,"64":0,"65":0,"66":0,"67":0,"68":0,"69":0,"70":0,"71":0,"72":0,"73":0,"74":0,"75":0,"76":0,"77":0,"78":0,"79":0,"80":0,"81":0,"82":0,"83":0,"84":0,"85":0,"86":0,"87":0,"88":0,"89":0,"90":0,"91":0,"92":0,"93":0,"94":0,"95":0,"96":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0,0],"10":[0,0,0],"11":[0,0],"12":[0,0],"13":[0,0],"14":[0,0],"15":[0,0],"16":[0,0],"17":[0,0],"18":[0,0],"19":[0,0],"20":[0,0],"21":[0,0],"22":[0,0],"23":[0,0,0,0],"24":[0,0],"25":[0,0,0,0],"26":[0,0],"27":[0,0],"28":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"1b03a79e0c4de170586fc7cc01470571c69a6857"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();var __decorate=(cov_cey5canse.s[0]++,(cov_cey5canse.b[0][0]++,this)&&(cov_cey5canse.b[0][1]++,this.__decorate)||(cov_cey5canse.b[0][2]++,function(decorators,target,key,desc){cov_cey5canse.f[0]++;var c=(cov_cey5canse.s[1]++,arguments.length),r=(cov_cey5canse.s[2]++,c<3?(cov_cey5canse.b[1][0]++,target):(cov_cey5canse.b[1][1]++,desc===null?(cov_cey5canse.b[2][0]++,desc=Object.getOwnPropertyDescriptor(target,key)):(cov_cey5canse.b[2][1]++,desc))),d;cov_cey5canse.s[3]++;if((cov_cey5canse.b[4][0]++,typeof Reflect==="object")&&(cov_cey5canse.b[4][1]++,typeof Reflect.decorate==="function")){cov_cey5canse.b[3][0]++;cov_cey5canse.s[4]++;r=Reflect.decorate(decorators,target,key,desc);}else{cov_cey5canse.b[3][1]++;cov_cey5canse.s[5]++;for(var i=(cov_cey5canse.s[6]++,decorators.length-1);i>=0;i--){cov_cey5canse.s[7]++;if(d=decorators[i]){cov_cey5canse.b[5][0]++;cov_cey5canse.s[8]++;r=(cov_cey5canse.b[6][0]++,c<3?(cov_cey5canse.b[7][0]++,d(r)):(cov_cey5canse.b[7][1]++,c>3?(cov_cey5canse.b[8][0]++,d(target,key,r)):(cov_cey5canse.b[8][1]++,d(target,key))))||(cov_cey5canse.b[6][1]++,r);}else{cov_cey5canse.b[5][1]++;}}}cov_cey5canse.s[9]++;return(cov_cey5canse.b[9][0]++,c>3)&&(cov_cey5canse.b[9][1]++,r)&&(cov_cey5canse.b[9][2]++,Object.defineProperty(target,key,r)),r;}));var __metadata=(cov_cey5canse.s[10]++,(cov_cey5canse.b[10][0]++,this)&&(cov_cey5canse.b[10][1]++,this.__metadata)||(cov_cey5canse.b[10][2]++,function(k,v){cov_cey5canse.f[1]++;cov_cey5canse.s[11]++;if((cov_cey5canse.b[12][0]++,typeof Reflect==="object")&&(cov_cey5canse.b[12][1]++,typeof Reflect.metadata==="function")){cov_cey5canse.b[11][0]++;cov_cey5canse.s[12]++;return Reflect.metadata(k,v);}else{cov_cey5canse.b[11][1]++;}}));cov_cey5canse.s[13]++;Object.defineProperty(exports,"__esModule",{value:true});const fabric_contract_api_1=(cov_cey5canse.s[14]++,require("fabric-contract-api"));const models_1=(cov_cey5canse.s[15]++,require("../models"));const repositories_1=(cov_cey5canse.s[16]++,require("../repositories"));const processing_engine_1=(cov_cey5canse.s[17]++,require("../processing-engine"));const Logger=(cov_cey5canse.s[18]++,require('../logger'));const logger=(cov_cey5canse.s[19]++,Logger.getLogger('./contracts/ifc-shipped.contract.ts'));cov_cey5canse.s[20]++;let InvoiceContract=class InvoiceContract extends fabric_contract_api_1.Contract{constructor(){cov_cey5canse.f[2]++;cov_cey5canse.s[21]++;super("com.homedepot.procurement.InvoiceContract");}// Used to bulk merge several records of new Invoice data with existing Invoice data
async bulkSaveInvoice(ctx,newListOfInvoiceLists){cov_cey5canse.f[3]++;cov_cey5canse.s[22]++;try{cov_cey5canse.s[23]++;// Sanity-checks: list.length > 0
if(newListOfInvoiceLists.length===0){cov_cey5canse.b[13][0]++;cov_cey5canse.s[24]++;throw new Error(`bulkSaveInvoice was called with 0 Invoices`);}else{cov_cey5canse.b[13][1]++;}// Add each set of PO items to the blockchain, one PONumber at a time
let aps=(cov_cey5canse.s[25]++,[]);cov_cey5canse.s[26]++;for(let currentItemsList of newListOfInvoiceLists){let currentSavedAP=(cov_cey5canse.s[27]++,await this.saveInvoice(ctx,currentItemsList.PONumber,currentItemsList.Items));cov_cey5canse.s[28]++;aps.push(currentSavedAP);}cov_cey5canse.s[29]++;return aps;}catch(e){cov_cey5canse.s[30]++;logger.error(`bulkSaveInvoice failed`);cov_cey5canse.s[31]++;logger.error(e);cov_cey5canse.s[32]++;return;}}// Used to merge new Invoice data with existing Invoice data
async saveInvoice(ctx,poNumber,newInvoiceList){cov_cey5canse.f[4]++;cov_cey5canse.s[33]++;try{cov_cey5canse.s[34]++;// Sanity-checks: invlist.length > 0, all items in invlist have PONumber=poNumber
poNumber=poNumber.trim();cov_cey5canse.s[35]++;if(newInvoiceList.length===0){cov_cey5canse.b[14][0]++;cov_cey5canse.s[36]++;throw new Error(`saveInvoice was called with 0 Invoice items, for PONumber '${poNumber}'`);}else{cov_cey5canse.b[14][1]++;}cov_cey5canse.s[37]++;if(newInvoiceList.some((v,i,l)=>{cov_cey5canse.f[5]++;cov_cey5canse.s[38]++;return v.PONumber!=poNumber;})){cov_cey5canse.b[15][0]++;cov_cey5canse.s[39]++;throw new Error(`saveInvoice was called with some Invoice items that do not have PONUmber '${poNumber}`);}else{cov_cey5canse.b[15][1]++;}let apRepo=(cov_cey5canse.s[40]++,new repositories_1.AssetProcurementRepository(ctx));// Retrieve or create the AssetProcurement record
let ap=(cov_cey5canse.s[41]++,new models_1.AssetProcurement({PONumber:poNumber}));let apIsNew=(cov_cey5canse.s[42]++,true);cov_cey5canse.s[43]++;if((await apRepo.exists(poNumber))==true){cov_cey5canse.b[16][0]++;cov_cey5canse.s[44]++;logger.debug(`PONumber ${poNumber} exists`);cov_cey5canse.s[45]++;ap=await apRepo.get(poNumber);cov_cey5canse.s[46]++;apIsNew=false;cov_cey5canse.s[47]++;logger.debug('Retreived AP from storage');}else{cov_cey5canse.b[16][1]++;}// Get the list of UnitOfMeasure data
cov_cey5canse.s[48]++;logger.debug('Retrieving UOM data from storage');let uomList=(cov_cey5canse.s[49]++,await new repositories_1.UnitOfMeasureListRepository(ctx).get());cov_cey5canse.s[50]++;if(uomList===undefined){cov_cey5canse.b[17][0]++;cov_cey5canse.s[51]++;uomList=new models_1.UnitOfMeasureList({Items:[]});}else{cov_cey5canse.b[17][1]++;}cov_cey5canse.s[52]++;logger.debug(uomList.Items.length);// Retrieve the current ADR Rule data
cov_cey5canse.s[53]++;logger.debug('Retrieving ADR Rules from storage');let adrRuleList=(cov_cey5canse.s[54]++,await new repositories_1.ADRRuleListRepository(ctx).get());cov_cey5canse.s[55]++;if(adrRuleList===undefined){cov_cey5canse.b[18][0]++;cov_cey5canse.s[56]++;adrRuleList=new models_1.ADRRuleList({Items:[]});}else{cov_cey5canse.b[18][1]++;}cov_cey5canse.s[57]++;logger.debug(adrRuleList.Items.length);// Merge the existing Invoice data with the new data
cov_cey5canse.s[58]++;logger.debug('We '+((cov_cey5canse.b[20][0]++,ap.Invoices!==undefined)&&(cov_cey5canse.b[20][1]++,ap.Invoices.length>0)?(cov_cey5canse.b[19][0]++,'have'):(cov_cey5canse.b[19][1]++,'do not have'))+' INV data for the AP');cov_cey5canse.s[59]++;if((cov_cey5canse.b[22][0]++,ap.Invoices!==undefined)&&(cov_cey5canse.b[22][1]++,ap.Invoices.length>0)){cov_cey5canse.b[21][0]++;cov_cey5canse.s[60]++;// Merge any records that match on key identifier fields
logger.debug(`Starting with ${newInvoiceList.length} new Invoices`);cov_cey5canse.s[61]++;newInvoiceList.forEach((vc,ic,lc)=>{cov_cey5canse.f[6]++;let existingRecordIndex=(cov_cey5canse.s[62]++,ap.Invoices.findIndex((innerVC,innerIC,innerLC)=>{cov_cey5canse.f[7]++;cov_cey5canse.s[63]++;return(cov_cey5canse.b[23][0]++,vc.RDC==innerVC.RDC)&&(cov_cey5canse.b[23][1]++,vc.SKU==innerVC.SKU)&&(cov_cey5canse.b[23][2]++,vc.PONumber==innerVC.PONumber)&&(cov_cey5canse.b[23][3]++,vc.InvoiceNumber==innerVC.InvoiceNumber);}));cov_cey5canse.s[64]++;if(existingRecordIndex>-1){cov_cey5canse.b[24][0]++;cov_cey5canse.s[65]++;logger.debug('Found a new INV that matched an existing one');cov_cey5canse.s[66]++;ap.Invoices[existingRecordIndex]=vc;}else{cov_cey5canse.b[24][1]++;}});// Deterimine all records that are new and do not match any existing records
let uniqueINVs=(cov_cey5canse.s[67]++,newInvoiceList.reduce((pac,vc,ic,lc)=>{cov_cey5canse.f[8]++;let existingRecordIndex=(cov_cey5canse.s[68]++,ap.Invoices.findIndex((innerVC,innerIC,innerLC)=>{cov_cey5canse.f[9]++;cov_cey5canse.s[69]++;return(cov_cey5canse.b[25][0]++,vc.RDC==innerVC.RDC)&&(cov_cey5canse.b[25][1]++,vc.SKU==innerVC.SKU)&&(cov_cey5canse.b[25][2]++,vc.PONumber==innerVC.PONumber)&&(cov_cey5canse.b[25][3]++,vc.InvoiceNumber==innerVC.InvoiceNumber);}));cov_cey5canse.s[70]++;if(existingRecordIndex==-1){cov_cey5canse.b[26][0]++;cov_cey5canse.s[71]++;logger.debug('Found a new INV that does not match the existing ones');cov_cey5canse.s[72]++;pac.push(vc);}else{cov_cey5canse.b[26][1]++;}cov_cey5canse.s[73]++;return pac;},[]));cov_cey5canse.s[74]++;logger.debug(`Ended up with ${uniqueINVs.length} totally new Invoices`);// If we found some new records to add, Append new records to the existing ones
cov_cey5canse.s[75]++;if(uniqueINVs.length>0){cov_cey5canse.b[27][0]++;cov_cey5canse.s[76]++;logger.debug('Adding the final list of unique INVs to the existing list of INVs');cov_cey5canse.s[77]++;ap.Invoices.push(...uniqueINVs);}else{cov_cey5canse.b[27][1]++;}}else{cov_cey5canse.b[21][1]++;cov_cey5canse.s[78]++;logger.debug('Adding all new INVs since there are no existing INVs.');cov_cey5canse.s[79]++;ap.setStageDetails(models_1.StageType.Invoiced,newInvoiceList);}// Run this through the processing engine (FSM)
cov_cey5canse.s[80]++;logger.debug('Starting the processing engine');let updatedAP=(cov_cey5canse.s[81]++,processing_engine_1.ProcessingEngine.startProcessing(ap,{uomList,adrRuleList}));cov_cey5canse.s[82]++;logger.debug('Finished the processing engine');// Save the AssetProcurement record
cov_cey5canse.s[83]++;if(apIsNew){cov_cey5canse.b[28][0]++;cov_cey5canse.s[84]++;logger.debug('Attempting to create a new AP');cov_cey5canse.s[85]++;await apRepo.create(updatedAP);}else{cov_cey5canse.b[28][1]++;cov_cey5canse.s[86]++;logger.debug('Attempting to update an existing AP');cov_cey5canse.s[87]++;await apRepo.update(updatedAP);}cov_cey5canse.s[88]++;logger.debug(`saveInvoice saved ${newInvoiceList.length} Invoice items for PONumber ${poNumber}`);cov_cey5canse.s[89]++;return updatedAP;}catch(e){cov_cey5canse.s[90]++;logger.error(`saveInvoice failed for PONumber ${poNumber}`);cov_cey5canse.s[91]++;logger.error(e);cov_cey5canse.s[92]++;return;}}};cov_cey5canse.s[93]++;__decorate([fabric_contract_api_1.Transaction(),fabric_contract_api_1.Param("newListOfInvoiceLists","InvoiceList[]"),fabric_contract_api_1.Returns('AssetProcurement[]'),__metadata("design:type",Function),__metadata("design:paramtypes",[fabric_contract_api_1.Context,Array]),__metadata("design:returntype",Promise)],InvoiceContract.prototype,"bulkSaveInvoice",null);cov_cey5canse.s[94]++;__decorate([fabric_contract_api_1.Transaction(),fabric_contract_api_1.Param("poNumber","string"),fabric_contract_api_1.Param("newInvoiceList","Invoice[]"),fabric_contract_api_1.Returns('AssetProcurement'),__metadata("design:type",Function),__metadata("design:paramtypes",[fabric_contract_api_1.Context,String,Array]),__metadata("design:returntype",Promise)],InvoiceContract.prototype,"saveInvoice",null);cov_cey5canse.s[95]++;InvoiceContract=__decorate([fabric_contract_api_1.Info({title:'InvoiceContract',description:'Contract for managing the list of Invoices, and their related discrepancies'}),__metadata("design:paramtypes",[])],InvoiceContract);cov_cey5canse.s[96]++;exports.InvoiceContract=InvoiceContract;//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXFVzZXJzXFxQUkFLQVNIU0VMVkFSQUpcXEJsb2NrY2hhaW5cXEhvbWUgRGVwb3RcXERldmVsb3BtZW50XFxjaGFpbmNvZGVfMDkwMVxcc3JjXFxjb250cmFjdHNcXGludm9pY2UuY29udHJhY3QudHMiLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcUFJBS0FTSFNFTFZBUkFKXFxCbG9ja2NoYWluXFxIb21lIERlcG90XFxEZXZlbG9wbWVudFxcY2hhaW5jb2RlXzA5MDFcXHNyY1xcY29udHJhY3RzXFxpbnZvaWNlLmNvbnRyYWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsNkRBQTJGO0FBQzNGLHNDQUFzSTtBQUN0SSxrREFBaUg7QUFDakgsNERBQXdEO0FBRXhELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNwQyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7QUFJdkUsSUFBYSxlQUFlLEdBQTVCLE1BQWEsZUFBZ0IsU0FBUSw4QkFBUTtJQUV6QyxnQkFBZ0IsS0FBSyxDQUFDLDJDQUEyQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBR3JFLG9GQUFvRjtJQUk3RSxLQUFLLENBQUMsZUFBZSxDQUFDLEdBQVksRUFBRSxxQkFBb0M7UUFDM0UsSUFBSTtZQUNBLGlDQUFpQztZQUNqQyxJQUFJLHFCQUFxQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUM7Z0JBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsNENBQTRDLENBQUMsQ0FBQzthQUNqRTtZQUVELHFFQUFxRTtZQUNyRSxJQUFJLEdBQUcsR0FBd0IsRUFBRSxDQUFDO1lBQ2xDLEtBQUssSUFBSSxnQkFBZ0IsSUFBSSxxQkFBcUIsRUFBRTtnQkFDaEQsSUFBSSxjQUFjLEdBQXNCLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLGdCQUFnQixDQUFD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STNCO0FBcklZLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29udGV4dCwgQ29udHJhY3QsIEluZm8sIFJldHVybnMsIFRyYW5zYWN0aW9uLCBQYXJhbSB9IGZyb20gJ2ZhYnJpYy1jb250cmFjdC1hcGknO1xyXG5pbXBvcnQgeyBJbnZvaWNlLCBBc3NldFByb2N1cmVtZW50LCBTdGFnZVR5cGUsIFVuaXRPZk1lYXN1cmUsIFVuaXRPZk1lYXN1cmVMaXN0LCBBRFJSdWxlLCBBRFJSdWxlTGlzdCwgSW52b2ljZUxpc3QgfSBmcm9tIFwiLi4vbW9kZWxzXCI7XHJcbmltcG9ydCB7IEFzc2V0UHJvY3VyZW1lbnRSZXBvc2l0b3J5LCBVbml0T2ZNZWFzdXJlTGlzdFJlcG9zaXRvcnksIEFEUlJ1bGVMaXN0UmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcmllcyc7XHJcbmltcG9ydCB7IFByb2Nlc3NpbmdFbmdpbmUgfSBmcm9tICcuLi9wcm9jZXNzaW5nLWVuZ2luZSc7XHJcblxyXG5jb25zdCBMb2dnZXIgPSByZXF1aXJlKCcuLi9sb2dnZXInKTtcclxuY29uc3QgbG9nZ2VyID0gTG9nZ2VyLmdldExvZ2dlcignLi9jb250cmFjdHMvaWZjLXNoaXBwZWQuY29udHJhY3QudHMnKTtcclxuXHJcblxyXG5ASW5mbyh7IHRpdGxlOiAnSW52b2ljZUNvbnRyYWN0JywgZGVzY3JpcHRpb246ICdDb250cmFjdCBmb3IgbWFuYWdpbmcgdGhlIGxpc3Qgb2YgSW52b2ljZXMsIGFuZCB0aGVpciByZWxhdGVkIGRpc2NyZXBhbmNpZXMnIH0pXHJcbmV4cG9ydCBjbGFzcyBJbnZvaWNlQ29udHJhY3QgZXh0ZW5kcyBDb250cmFjdCB7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7IHN1cGVyKFwiY29tLmhvbWVkZXBvdC5wcm9jdXJlbWVudC5JbnZvaWNlQ29udHJhY3RcIik7IH1cclxuXHJcblxyXG4gICAgLy8gVXNlZCB0byBidWxrIG1lcmdlIHNldmVyYWwgcmVjb3JkcyBvZiBuZXcgSW52b2ljZSBkYXRhIHdpdGggZXhpc3RpbmcgSW52b2ljZSBkYXRhXHJcbiAgICBAVHJhbnNhY3Rpb24oKVxyXG4gICAgQFBhcmFtKFwibmV3TGlzdE9mSW52b2ljZUxpc3RzXCIsIFwiSW52b2ljZUxpc3RbXVwiKVxyXG4gICAgQFJldHVybnMoJ0Fzc2V0UHJvY3VyZW1lbnRbXScpICAgIFxyXG4gICAgcHVibGljIGFzeW5jIGJ1bGtTYXZlSW52b2ljZShjdHg6IENvbnRleHQsIG5ld0xpc3RPZkludm9pY2VMaXN0czogSW52b2ljZUxpc3RbXSk6IFByb21pc2U8QXNzZXRQcm9jdXJlbWVudFtdPiB7ICBcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBTYW5pdHktY2hlY2tzOiBsaXN0Lmxlbmd0aCA+IDBcclxuICAgICAgICAgICAgaWYgKG5ld0xpc3RPZkludm9pY2VMaXN0cy5sZW5ndGggPT09IDApeyBcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgYnVsa1NhdmVJbnZvaWNlIHdhcyBjYWxsZWQgd2l0aCAwIEludm9pY2VzYCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIEFkZCBlYWNoIHNldCBvZiBQTyBpdGVtcyB0byB0aGUgYmxvY2tjaGFpbiwgb25lIFBPTnVtYmVyIGF0IGEgdGltZVxyXG4gICAgICAgICAgICBsZXQgYXBzIDogQXNzZXRQcm9jdXJlbWVudFtdID0gW107XHJcbiAgICAgICAgICAgIGZvciAobGV0IGN1cnJlbnRJdGVtc0xpc3Qgb2YgbmV3TGlzdE9mSW52b2ljZUxpc3RzKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY3VycmVudFNhdmVkQVAgOiBBc3NldFByb2N1cmVtZW50ID0gYXdhaXQgdGhpcy5zYXZlSW52b2ljZShjdHgsIGN1cnJlbnRJdGVtc0xpc3QuUE9OdW1iZXIsIGN1cnJlbnRJdGVtc0xpc3QuSXRlbXMpO1xyXG4gICAgICAgICAgICAgICAgYXBzLnB1c2goY3VycmVudFNhdmVkQVApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gYXBzO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGBidWxrU2F2ZUludm9pY2UgZmFpbGVkYCk7XHJcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgLy8gVXNlZCB0byBtZXJnZSBuZXcgSW52b2ljZSBkYXRhIHdpdGggZXhpc3RpbmcgSW52b2ljZSBkYXRhXHJcbiAgICBAVHJhbnNhY3Rpb24oKVxyXG4gICAgQFBhcmFtKFwicG9OdW1iZXJcIiwgXCJzdHJpbmdcIilcclxuICAgIEBQYXJhbShcIm5ld0ludm9pY2VMaXN0XCIsIFwiSW52b2ljZVtdXCIpXHJcbiAgICBAUmV0dXJucygnQXNzZXRQcm9jdXJlbWVudCcpICAgIFxyXG4gICAgcHVibGljIGFzeW5jIHNhdmVJbnZvaWNlKGN0eDogQ29udGV4dCwgcG9OdW1iZXI6IHN0cmluZywgbmV3SW52b2ljZUxpc3Q6IEludm9pY2VbXSk6IFByb21pc2U8QXNzZXRQcm9jdXJlbWVudD4geyAgXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgLy8gU2FuaXR5LWNoZWNrczogaW52bGlzdC5sZW5ndGggPiAwLCBhbGwgaXRlbXMgaW4gaW52bGlzdCBoYXZlIFBPTnVtYmVyPXBvTnVtYmVyXHJcbiAgICAgICAgICAgIHBvTnVtYmVyID0gcG9OdW1iZXIudHJpbSgpO1xyXG4gICAgICAgICAgICBpZiAobmV3SW52b2ljZUxpc3QubGVuZ3RoID09PSAwKXsgXHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHNhdmVJbnZvaWNlIHdhcyBjYWxsZWQgd2l0aCAwIEludm9pY2UgaXRlbXMsIGZvciBQT051bWJlciAnJHtwb051bWJlcn0nYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG5ld0ludm9pY2VMaXN0LnNvbWUoKHYsaSxsKT0+eyByZXR1cm4gKHYuUE9OdW1iZXIgIT0gcG9OdW1iZXIpOyB9KSkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBzYXZlSW52b2ljZSB3YXMgY2FsbGVkIHdpdGggc29tZSBJbnZvaWNlIGl0ZW1zIHRoYXQgZG8gbm90IGhhdmUgUE9OVW1iZXIgJyR7cG9OdW1iZXJ9YCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBhcFJlcG8gOiBBc3NldFByb2N1cmVtZW50UmVwb3NpdG9yeSA9IG5ldyBBc3NldFByb2N1cmVtZW50UmVwb3NpdG9yeShjdHgpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gUmV0cmlldmUgb3IgY3JlYXRlIHRoZSBBc3NldFByb2N1cmVtZW50IHJlY29yZFxyXG4gICAgICAgICAgICBsZXQgYXAgOiBBc3NldFByb2N1cmVtZW50ID0gbmV3IEFzc2V0UHJvY3VyZW1lbnQoeyBQT051bWJlcjogcG9OdW1iZXIgfSk7XHJcbiAgICAgICAgICAgIGxldCBhcElzTmV3IDogYm9vbGVhbiA9IHRydWU7XHJcbiAgICAgICAgICAgIGlmIChhd2FpdCBhcFJlcG8uZXhpc3RzKHBvTnVtYmVyKSA9PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoYFBPTnVtYmVyICR7cG9OdW1iZXJ9IGV4aXN0c2ApO1xyXG4gICAgICAgICAgICAgICAgYXAgPSBhd2FpdCBhcFJlcG8uZ2V0KHBvTnVtYmVyKTtcclxuICAgICAgICAgICAgICAgIGFwSXNOZXcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnUmV0cmVpdmVkIEFQIGZyb20gc3RvcmFnZScpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBHZXQgdGhlIGxpc3Qgb2YgVW5pdE9mTWVhc3VyZSBkYXRhXHJcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnUmV0cmlldmluZyBVT00gZGF0YSBmcm9tIHN0b3JhZ2UnKTtcclxuICAgICAgICAgICAgbGV0IHVvbUxpc3QgOiBVbml0T2ZNZWFzdXJlTGlzdCB8IHVuZGVmaW5lZCA9IGF3YWl0IChuZXcgVW5pdE9mTWVhc3VyZUxpc3RSZXBvc2l0b3J5KGN0eCkpLmdldCgpO1xyXG4gICAgICAgICAgICBpZiAodW9tTGlzdCA9PT0gdW5kZWZpbmVkKXsgdW9tTGlzdCA9IG5ldyBVbml0T2ZNZWFzdXJlTGlzdCh7IEl0ZW1zOiBbXSB9KTsgfVxyXG4gICAgICAgICAgICBsb2dnZXIuZGVidWcodW9tTGlzdC5JdGVtcy5sZW5ndGgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICAvLyBSZXRyaWV2ZSB0aGUgY3VycmVudCBBRFIgUnVsZSBkYXRhXHJcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnUmV0cmlldmluZyBBRFIgUnVsZXMgZnJvbSBzdG9yYWdlJyk7XHJcbiAgICAgICAgICAgIGxldCBhZHJSdWxlTGlzdCA6IEFEUlJ1bGVMaXN0IHwgdW5kZWZpbmVkID0gYXdhaXQgKG5ldyBBRFJSdWxlTGlzdFJlcG9zaXRvcnkoY3R4KSkuZ2V0KCk7XHJcbiAgICAgICAgICAgIGlmIChhZHJSdWxlTGlzdCA9PT0gdW5kZWZpbmVkKXsgYWRyUnVsZUxpc3QgPSBuZXcgQURSUnVsZUxpc3QoeyBJdGVtczogW10gfSk7IH1cclxuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGFkclJ1bGVMaXN0Lkl0ZW1zLmxlbmd0aCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBNZXJnZSB0aGUgZXhpc3RpbmcgSW52b2ljZSBkYXRhIHdpdGggdGhlIG5ldyBkYXRhXHJcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnV2UgJyArICgoYXAuSW52b2ljZXMgIT09IHVuZGVmaW5lZCAmJiBhcC5JbnZvaWNlcy5sZW5ndGggPiAwKSA/ICdoYXZlJyA6ICdkbyBub3QgaGF2ZScpICsgJyBJTlYgZGF0YSBmb3IgdGhlIEFQJyk7XHJcbiAgICAgICAgICAgIGlmIChhcC5JbnZvaWNlcyAhPT0gdW5kZWZpbmVkICYmIGFwLkludm9pY2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIC8vIE1lcmdlIGFueSByZWNvcmRzIHRoYXQgbWF0Y2ggb24ga2V5IGlkZW50aWZpZXIgZmllbGRzXHJcbiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoYFN0YXJ0aW5nIHdpdGggJHtuZXdJbnZvaWNlTGlzdC5sZW5ndGh9IG5ldyBJbnZvaWNlc2ApO1xyXG4gICAgICAgICAgICAgICAgbmV3SW52b2ljZUxpc3QuZm9yRWFjaCgodmMsaWMsbGMpPT57XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGV4aXN0aW5nUmVjb3JkSW5kZXggPSBhcC5JbnZvaWNlcyEuZmluZEluZGV4KChpbm5lclZDLGlubmVySUMsaW5uZXJMQyk9PntcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZjLlJEQz09aW5uZXJWQy5SREMgJiYgdmMuU0tVID09IGlubmVyVkMuU0tVICYmIHZjLlBPTnVtYmVyID09IGlubmVyVkMuUE9OdW1iZXIgJiYgdmMuSW52b2ljZU51bWJlciA9PSBpbm5lclZDLkludm9pY2VOdW1iZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUmVjb3JkSW5kZXggPiAtMSkgeyBcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdGb3VuZCBhIG5ldyBJTlYgdGhhdCBtYXRjaGVkIGFuIGV4aXN0aW5nIG9uZScpOyBcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXAuSW52b2ljZXMhW2V4aXN0aW5nUmVjb3JkSW5kZXhdID0gdmM7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gRGV0ZXJpbWluZSBhbGwgcmVjb3JkcyB0aGF0IGFyZSBuZXcgYW5kIGRvIG5vdCBtYXRjaCBhbnkgZXhpc3RpbmcgcmVjb3Jkc1xyXG4gICAgICAgICAgICAgICAgbGV0IHVuaXF1ZUlOVnMgOiBJbnZvaWNlW10gPSBuZXdJbnZvaWNlTGlzdC5yZWR1Y2UoKHBhYzpJbnZvaWNlW10sdmMsaWMsbGMpPT57XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGV4aXN0aW5nUmVjb3JkSW5kZXggPSBhcC5JbnZvaWNlcyEuZmluZEluZGV4KChpbm5lclZDLGlubmVySUMsaW5uZXJMQyk9PntcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZjLlJEQz09aW5uZXJWQy5SREMgJiYgdmMuU0tVID09IGlubmVyVkMuU0tVICYmIHZjLlBPTnVtYmVyID09IGlubmVyVkMuUE9OdW1iZXIgJiYgdmMuSW52b2ljZU51bWJlciA9PSBpbm5lclZDLkludm9pY2VOdW1iZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUmVjb3JkSW5kZXggPT0gLTEpIHsgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnRm91bmQgYSBuZXcgSU5WIHRoYXQgZG9lcyBub3QgbWF0Y2ggdGhlIGV4aXN0aW5nIG9uZXMnKTsgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhYy5wdXNoKHZjKTsgXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYWM7XHJcbiAgICAgICAgICAgICAgICB9LCBbXSk7XHJcbiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoYEVuZGVkIHVwIHdpdGggJHt1bmlxdWVJTlZzLmxlbmd0aH0gdG90YWxseSBuZXcgSW52b2ljZXNgKTtcclxuICBcclxuICAgICAgICAgICAgICAgIC8vIElmIHdlIGZvdW5kIHNvbWUgbmV3IHJlY29yZHMgdG8gYWRkLCBBcHBlbmQgbmV3IHJlY29yZHMgdG8gdGhlIGV4aXN0aW5nIG9uZXNcclxuICAgICAgICAgICAgICAgIGlmICh1bmlxdWVJTlZzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoJ0FkZGluZyB0aGUgZmluYWwgbGlzdCBvZiB1bmlxdWUgSU5WcyB0byB0aGUgZXhpc3RpbmcgbGlzdCBvZiBJTlZzJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgYXAuSW52b2ljZXMucHVzaCguLi51bmlxdWVJTlZzKTtcclxuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdBZGRpbmcgYWxsIG5ldyBJTlZzIHNpbmNlIHRoZXJlIGFyZSBubyBleGlzdGluZyBJTlZzLicpO1xyXG4gICAgICAgICAgICAgICAgYXAuc2V0U3RhZ2VEZXRhaWxzKFN0YWdlVHlwZS5JbnZvaWNlZCwgbmV3SW52b2ljZUxpc3QpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBSdW4gdGhpcyB0aHJvdWdoIHRoZSBwcm9jZXNzaW5nIGVuZ2luZSAoRlNNKVxyXG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoJ1N0YXJ0aW5nIHRoZSBwcm9jZXNzaW5nIGVuZ2luZScpO1xyXG4gICAgICAgICAgICBsZXQgdXBkYXRlZEFQIDogQXNzZXRQcm9jdXJlbWVudCA9IFByb2Nlc3NpbmdFbmdpbmUuc3RhcnRQcm9jZXNzaW5nKGFwLCB7IHVvbUxpc3QsIGFkclJ1bGVMaXN0IH0pO1xyXG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoJ0ZpbmlzaGVkIHRoZSBwcm9jZXNzaW5nIGVuZ2luZScpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gU2F2ZSB0aGUgQXNzZXRQcm9jdXJlbWVudCByZWNvcmRcclxuICAgICAgICAgICAgaWYgKGFwSXNOZXcpIHtcclxuICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnQXR0ZW1wdGluZyB0byBjcmVhdGUgYSBuZXcgQVAnKTtcclxuICAgICAgICAgICAgICAgIGF3YWl0IGFwUmVwby5jcmVhdGUodXBkYXRlZEFQKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnQXR0ZW1wdGluZyB0byB1cGRhdGUgYW4gZXhpc3RpbmcgQVAnKTtcclxuICAgICAgICAgICAgICAgIGF3YWl0IGFwUmVwby51cGRhdGUodXBkYXRlZEFQKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGBzYXZlSW52b2ljZSBzYXZlZCAke25ld0ludm9pY2VMaXN0Lmxlbmd0aH0gSW52b2ljZSBpdGVtcyBmb3IgUE9OdW1iZXIgJHtwb051bWJlcn1gKTtcclxuICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRBUDtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihgc2F2ZUludm9pY2UgZmFpbGVkIGZvciBQT051bWJlciAke3BvTnVtYmVyfWApO1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoZSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59Il19